Botnet: network of compromised systems (bots) that are infected by malware (bot binary)
Bots receive and respond to commands from a **Command & Control** server (C&C server)
C&C server acts as rendezvous mechanism between bots and human controller **(botmaster)**

Bot net exists to carry out attacks for the bot master. It is just a bunch of computing power that you can do things with. 

![[Botnets.png]]

"One quarter of all computers are part of botnet" 
“Computers of at least 5-10% of all Dutch broadband subscribers in 2009 were part of a botnet”

![[Botnets stats.png]]

Sometimes botnets are shut down but it takes a lot of effort with limited success. Botnets also spread **ransomware**.

## Botnet life cycle 

1. Injection - The host gets injected with mallware
2. Rallying  - The bot contacts C&C server to say its online & etablish communication channel.
3. Passive - Bot awaits commands (binary may be updated)
4. Active - Bot carries out malicious activity 
	- Optionally bot spreads infection to other hosts using propagation (worm like behavior)

![[Botnets cycle.png]]

## Bot net propagation

Either active or passive. 

**Active propagation** The botnet can scan for vulnerable machines and infect them.
**Passive propagation** happens by people falling into traps. 
- Drive-by download: installed by js through javascript
- Infected media: sharing a usb stick
- Social engineering: Entice user to click something malicious like good old ms word with macros 

## Rallying

How does a bot reach the C&C server? The binary either knows the domain name of C&C and goes there. Can be a nice website with special port. Either **hardcoded in binary** or generated by DGA (domain name generation)
Or the bot knows the ip adress of the C&C server. Stops dns queries so is harder to detect but the ip can also lead the C&C to get compromised. Ip can be spread by **seeding** with initial list of peers. 

## C&C communication 

Typically just use normal protocols it works and makes detection more difficult. Used to be IRC now is just http. But recently also peer to peer using BitTorrent etc with a p2p network.

## Detection Evasion Mechanisms

Botnets want to stay hidden. They have multipe mechanisms to evade detection of:

### Bot or bot binary  detection evasion

- **Binary obfuscation**
		- polymorphism: ability of bot binary to take several forms eg. by encryption or compression
  - **Anti analysis** 
	  - Bot binary can check enviroment where it is executed. Like if it is in VM don't run. But this is at costs of loosing targets because people also do really run vm. Not populair.
	  - **Security suppresion**: Bot binary just disables security hardware/software on victim machine
  - **Rootkit technology**: bot binary may subvert OS to remain persisitent and undetectable 
  
### C&C servers detection prevention 

- **IP flux (fast flux)**  
		 - Frequently change ip address associated with C&C server but keep domain name the same
		 - Helps eveding blacklisting of ip
		 - Real time update of DNS is easy with DDNS (Dynamic DNS)
   
   > **DNS** maps domain names to static ip
   > **DDNS** maps domain names to dynamic ip. Exists becuse ips given by isp can change from time to time. To allow customers to run servers DDNS is created. Web service stays accisible. 
   

The bots evade detection by first resolving the domain name with (d)dns to an ip adres and then they send request to that ip adres. Flux is having multiple of something. 

- Single Flux 
	- Bots do not communicate directly with bot server but through proxy bots. These are special bots that just relay communication. 
	- DNS is set with short ttl (few seconds) to it is rechecked often
- Botnet alternates between different proxy bots (maybe round robin)
- Botnet also uses doman name for a short time and then patches bots to use new domain naem with new set of proxy bots.

- Double flux
	- Also make the dns server only accisble by proxy bots
	- Ip address of name server changes often.
- Encrypted DNS
- Domain flux
	- Associate multiple domain names to the same ip
	- This helps url based detection 
	- DGA (domain name generation algorithm)
- Anonymization - Using tor for communication 
	- Host C&C server on tor

![[Botnets C&C.png]]

## DGA 

DGA (domain name generation algoritm) bot applies DGA to generate a large number during runtime of domain names with only some being actually active or just one. Bot then uses dns to resolve them and probably only one resolves and is C&C server. You can try analyse botnet binary to see which list is going to generate. But the idea is that the goverment can't seize all of them. 

These DGA work with a seed. This can be **static seed** derived from data like data of computer, the set of domain names generated last time etc.  

Conficker.C generated 50.000 domain names of which bots daily tried up to 500 
- law enforcement would have to pre-register and check 50.000 domain names 
- if botmaster registers only 1 domain name, bot has 1% chance per day to contact C&C server, hence bot will contact C&C server once every 100 days on average. 

Cool idea. Easy to do for botnet but to take over you require other party to register a bunch of domain names. 

It can also be a **dynamic seed** like stock prices of certain stock or exchange rates of money. This can not be predicted.

DGA come in 4 types:

- **Arithmetic-based:** construct domain names by generating sequences of ASCII characters 
	- domain names typically consist of random sequences of characters (letters and digits) 
- **Hash-based:** construct domain names from hashing algorithms such as MD5 and SHA256 
	- domain names represent hexadecimal number and consist of digits and letters A-F 
	- Quite detectable 
- **Wordlist-based:** construct domain names by concatenating sequences of words from dictionaries 
	- domain names are less random, far harder to distinguish from regular domain names 
- **Permutation-based:** construct domain names through permutation of initial domain name 
	- domain names look similar to regular domain names
 
Then there is a force that works against this that tries to detect face domain names. Using machine learning. 

### C&C communication hiding

- Use encryption
- Protocol manipilation, tunneling to disguise C&C communication. IPv6 tunneling because no one uses ipv6 also direct connection. 
- Send low amounts of traffic to stay undetected.  
- Novel communication technies like sending images or social networks to communicate 

### Evasion tactics of Botmaster 

Botmaster is the most protected part of botnet. They use so called stepping stones to connect to C&C.

- Bot masters hide their true identity by setting up a number of intermediate hosts between the C&C server and themselves
- Put stepping stones in countries with lax cybercrime regulation 
- Makes it hard for trace back technology

Opposed to all these evasion attacks we also got [[Attacking botnets]].

## Botnet Topology 

There are 3 types of botnet topology. 

![[Botnets topology.png]]

![[Botnets centrilized.png]]

Centrilzed is lower complexity but more detectable with lower latency and lower surviability. 

![[Botnets decentrilzed.png]]

Decentrilzed is more compilcated but less detectable but more latency and survivability. 

![[Botnets Hybrid.png]]

All these topologies are used. 

